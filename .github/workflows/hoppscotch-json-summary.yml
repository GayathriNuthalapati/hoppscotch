name: Run Hoppscotch Collection

on:
  push:
    branches: 
      - main
  pull_request:
    branches:
      - main

jobs:
  hoppscotch_tests:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout Repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Setup Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "22"

      # Step 3: Install Hoppscotch CLI
      - name: Install Hoppscotch CLI
        run: npm install -g @hoppscotch/cli

      # Step 4: Debug reporter flags
      - name: Debug Hoppscotch CLI info
        run: |
          echo "=== HOPP GLOBAL HELP ==="
          hopp --help
          echo "=== HOPP TEST HELP ==="
          hopp test --help

      # Step 5: Run tests — DO NOT STOP ON FAILURE
      - name: Run Hoppscotch Tests
        continue-on-error: true
        run: |
          set +e
          echo "Trying: --reporter-junit-export"
          hopp test "hoppscotch-collection.json" \
            --env "hoppscotch-env.json" \
            --reporter-junit-export "report.xml"

          if [ ! -f report.xml ]; then
            echo "Fallback: Trying --reporter-junit"
            hopp test "hoppscotch-collection.json" \
              --env "hoppscotch-env.json" \
              --reporter-junit "report.xml"
          fi
          set -e

      # Step 6: Upload XML artifact
      - name: Upload report.xml artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hoppscotch-xml-report
          path: report.xml
          if-no-files-found: warn

      # Step 7: Ensure XML exists
      - name: Ensure report.xml exists
        if: always()
        run: |
          if [ ! -f report.xml ]; then
            echo "❌ report.xml NOT created!"
            ls -R .
            exit 1
          fi
          echo "✅ report.xml found"

      # Step 8: Convert XML → JSON
      - name: Convert XML to JSON Summary
        if: always()
        shell: pwsh
        run: |
          [xml]$xml = Get-Content 'report.xml'

          $totalTests = 0; $passed = 0; $failed = 0; $totalRequests = 0; $results = @()

          foreach ($suite in $xml.testsuites.testsuite) {
              $totalRequests++
              foreach ($case in $suite.testcase) {
                  $totalTests++
                  if ($case.failure) {
                      $status = 'fail'
                      $failed++
                  } else {
                      $status = 'pass'
                      $passed++
                  }

                  $results += [PSCustomObject]@{
                      testsuite = $suite.name
                      testcase  = $case.name
                      status    = $status
                      message   = $(if ($case.failure) { $case.failure.message } else { '' })
                  }
              }
          }

          $output = [PSCustomObject]@{
              summary = [PSCustomObject]@{
                  total_tests    = $totalTests
                  passed         = $passed
                  failed         = $failed
                  total_requests = $totalRequests
              }
              results = $results
          }

          $output | ConvertTo-Json -Depth 10 | Set-Content 'hoppscotch-summary.json'
          Write-Host "Summary JSON created"

      # Step 9: Upload JSON summary artifact
      - name: Upload Summary JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hoppscotch-summary
          path: hoppscotch-summary.json

      # Step 10: Send summary JSON to Datadog
      - name: Send summary JSON to Datadog
        if: always()
        shell: pwsh
        env:
          DD_API_KEY: ${{ secrets.DD_API_KEY }}
        run: |
          $latestFile = Get-ChildItem "." -Filter "hoppscotch-summary*.json" |
                        Sort-Object LastWriteTime -Descending |
                        Select-Object -First 1

          if (-not $latestFile) {
              Write-Error "No Hoppscotch summary JSON found!"
              exit 1
          }

          $summary = Get-Content $latestFile.FullName -Raw | ConvertFrom-Json

          $payload = @(
              @{
                  ddsource = "hoppscotch"
                  service = "api-automation-tests"
                  hostname = "github-actions"
                  message = "Hoppscotch Test Summary"
                  hoppscotch_summary = $summary
              }
          ) | ConvertTo-Json -Depth 15

          if (-not $env:DD_API_KEY) {
              Write-Error "DD_API_KEY environment variable is NOT set!"
              exit 1
          }

          Invoke-RestMethod `
              -Uri "https://http-intake.logs.us5.datadoghq.com/api/v2/logs" `
              -Method Post `
              -Headers @{
                  "DD-API-KEY" = $env:DD_API_KEY
                  "Content-Type" = "application/json"
              } `
              -Body $payload

          Write-Host "✅ Hoppscotch summary sent to Datadog"
