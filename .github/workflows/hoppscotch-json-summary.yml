name: Hoppscotch API Tests

on:
  push:
    branches: 
      - main
  pull_request:
    branches:
      - main

jobs:
  hoppscotch-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install Hoppscotch CLI
      - name: Install Hoppscotch CLI
        run: npm install -g @hoppscotch/cli

      # Run Hoppscotch Tests (DO NOT STOP workflow even if failed)
      - name: Run Hoppscotch tests
        run: |
          set +e
          hopp test "./newman-test.json" \
            --env "./newman-test-env.json" \
            --reporter-junit "./report.xml"
          echo "Tests may have failed, but workflow will continue."
          set -e

      # Ensure report.xml exists
      - name: Check report.xml exists
        run: |
          if [ ! -f report.xml ]; then
            echo "❌ report.xml was NOT created!"
            ls -R .
            exit 1
          else
            echo "✅ report.xml found"
          fi

      # Convert report.xml → hoppscotch-summary.json
      - name: Convert XML → JSON Summary
        shell: pwsh
        run: |
          [xml]$xml = Get-Content 'report.xml';
          $totalTests = 0; $passed = 0; $failed = 0; $totalRequests = 0; $results = @();

          foreach ($suite in $xml.testsuites.testsuite) {
              $totalRequests++;
              foreach ($case in $suite.testcase) {
                  $totalTests++;
                  if ($case.failure) {
                      $status = 'fail';
                      $failed++;
                  } else {
                      $status = 'pass';
                      $passed++;
                  }

                  $results += [PSCustomObject]@{
                      testsuite = $suite.name
                      testcase  = $case.name
                      status    = $status
                      message   = $(if ($case.failure) { $case.failure.message } else { '' })
                  }
              }
          }

          $output = [PSCustomObject]@{
              summary = [PSCustomObject]@{
                  total_tests    = $totalTests
                  passed         = $passed
                  failed         = $failed
                  total_requests = $totalRequests
              }
              results = $results
          }

          $output | ConvertTo-Json -Depth 15 | Set-Content 'hoppscotch-summary.json'
          Write-Host "✅ Summary JSON created: hoppscotch-summary.json"

      # Upload artifacts (report.xml + summary JSON)
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: hoppscotch-artifacts
          path: |
            report.xml
            hoppscotch-summary.json
          if-no-files-found: warn

      # Send JSON summary to Datadog
      - name: Send summary to Datadog
        run: |
          FILE="hoppscotch-summary.json"
          if [ ! -f "$FILE" ]; then
            echo "❌ Summary JSON not found"
            exit 0
          fi

          PAYLOAD=$(jq -n \
            --argfile summary "$FILE" \
            '{ 
                ddsource: "hoppscotch",
                service: "api-automation-tests",
                hostname: "hoppscotch-test",
                message: "Hoppscotch Test Summary Report",
                hoppscotch_summary: $summary
            }'
          )

          curl -X POST "https://http-intake.logs.us5.datadoghq.com/api/v2/logs" \
            -H "DD-API-KEY: ${{ secrets.DD_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "[$PAYLOAD]"
        shell: bash
